/* Auto-generated app.js - local-file friendly (no fetch) */
const QUESTIONS = {
  "meta": {
    "title": "אני והסיפור שלנו",
    "version": "1.0",
    "board": { "rows": 7, "cols": 6 },
    "categoriesOrder": ["history", "places", "figures", "values", "symbols", "achievements"]
  },
  "categories": {
    "history": {
      "label": "היסטוריה",
      "questions": [
        { "id": "history-1", "points": 10, "type": "for_everyone", "autoScore": true, "question": "למי נאמר: \"לך לך מארצך, ממולדתך ומבית אביך אל הארץ אשר אראך\"?", "options": ["אברהם", "יצחק", "יעקב", "משה"], "answer": "אברהם", "hint": "" },
        { "id": "history-2", "points": 15, "type": "personal", "question": "איזה חג חוגגים כזכרון ליציאת מצרים? ואיזה מצווה בחג היא זכרון לתקופה?.", "options": [], "answer": "חג הפסח", "hint": "" },
        { "id": "history-3", "points": 20, "type": "duel", "question": "כל קבוצה אומרת בתורה אחד מעשרת הדיברות. 5 שניות בלי תשובה- ניצחון לקבוצה השניה.", "options": [], "answer": "", "hint": "" },
        { "id": "history-4", "points": 5, "type": "regular", "question": "", "options": [""], "answer": "", "hint": "" },
        { "id": "history-5", "points": 15, "type": "personal", "question": "מי בנה את בית המקדש הראשון?", "options": [], "answer": "", "hint": "" },
        { "id": "history-6", "points": 5, "type": "regular", "question": "בין אילו שנים הייתנ מלחמת העולם השניה? לרשום על הדף ולהראות.", "options": [], "answer": "", "hint": "" },
        { "id": "history-7", "points": 5, "type": "regular", "question": "כמה אנשים חתומים על מגילת העצמאות?.", "options": [], "answer": "", "hint": "" }
      ]
    },

    "places": {
      "label": "מקומות",
      "questions": [
        { "id": "places-1", "points": 20, "type": "duel", "question": "דו־קרב: הר הבית — ע\"פ המסורת היהודית, מה מיוחד במקום הזה?", "options": [], "answer": "מקום בית המקדש (אבן השתייה / קודש הקודשים).", "hint": "אין גלגל הצלה" },
        { "id": "places-2", "points": 5, "type": "regular", "question": "הכנסת — מהו שם נרדף לכנסת?", "options": [], "answer": "בית המחוקקים / בית הנבחרים.", "hint": "" },
        { "id": "places-3", "points": 5, "type": "regular", "question": "שער האריות — איזה אירוע מכונן ארע במקום הזה?", "options": [], "answer": "שחרור ירושלים/העיר העתיקה במלחמת ששת הימים (1967) דרך שער האריות.", "hint": "" },
        { "id": "places-4", "points": 5, "type": "regular", "question": "יד ושם — מה פירוש הביטוי \"חסידי אומות העולם\"?", "options": [], "answer": "לא־יהודים שסיכנו את חייהם להצלת יהודים בשואה.", "hint": "" },
        { "id": "places-5", "points": 5, "type": "regular", "question": "מנו שלושה מקומות/אזורים בארץ שקרויים על שם השבטים שהתיישבו שם.", "options": [], "answer": "דוגמאות: גוש דן (דן), מטה יהודה (יהודה), רמת מנשה (מנשה), מעלה אפרים (אפרים), מטה זבולון (זבולון).", "hint": "" },
        { "id": "places-6", "points": 15, "type": "personal", "question": "שאלה אישית: באיזו עיר בארץ צולמה התמונה הבאה? (להציג תמונה)", "options": [], "answer": "", "hint": "המנחה מציג תמונה" },
        { "id": "places-7", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: זהו את התמונות הבאות (כל תמונה = 2 נק׳): כותל, מערת המכפילה, מצדה, ים המלח, בנייני עזריאלי.", "options": [], "answer": "כותל / מערת המכפילה / מצדה / ים המלח / עזריאלי.", "hint": "סה\"כ 10 נק׳" }
      ]
    },

    "figures": {
      "label": "דמויות",
      "questions": [
        { "id": "figures-1", "points": 15, "type": "personal", "question": "שאלה אישית: מי כתב את ספר תהילים?", "options": [], "answer": "דוד המלך (עיקר הספר מיוחס לו).", "hint": "" },
        { "id": "figures-2", "points": 20, "type": "duel", "question": "דו־קרב: נכון/לא נכון על אסתר המלכה (כל תשובה נכונה = 4 נק׳). 1) אסתר הייתה אשתו של המן. 2) אסתר הלכה לארמון מרצון כדי לבחור בה. 3) אסתר צמה שלושה ימים ושלושה לילות. 4) אסתר נתלתה על העץ כי מרדה במלך. 5) אסתר עשתה שתי משתהות לאחשוורוש ולהמן יום אחרי יום.", "options": [], "answer": "1) לא נכון. 2) לא נכון. 3) נכון. 4) לא נכון. 5) נכון.", "hint": "אין גלגל הצלה" },
        { "id": "figures-3", "points": 5, "type": "regular", "question": "המנהיג הראשון של עם ישראל (מי הוביל את העם ביציאת מצרים)?", "options": [], "answer": "משה רבנו.", "hint": "" },
        { "id": "figures-4", "points": 5, "type": "regular", "question": "חתמתי על מגילת העצמאות, אני ראש הממשלה הרביעי של מדינת ישראל. שם משפחתי הראשון היה מאירסון, הייתי רה\"מ בזמן מלחמת יום הכיפורים… מי אני?", "options": [], "answer": "גולדה מאיר.", "hint": "" },
        { "id": "figures-5", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: מוצגת תמונה של פרופ׳ אלברט איינשטיין — זהו את הדמות ומה פועלה.", "options": [], "answer": "אלברט איינשטיין — פיזיקאי; תורת היחסות ועוד.", "hint": "" },
        { "id": "figures-6", "points": 15, "type": "personal", "question": "שאלה אישית בשני חלקים: 1) מי היה ש\"י עגנון? 2) מה הם ראשי התיבות ש\"י?", "options": [], "answer": "1) סופר עברי, חתן פרס נובל לספרות. 2) שמואל יוסף.", "hint": "" },
        { "id": "figures-7", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: המנחה מציג חפצים — למי הם שייכים? (דגל חיל האוויר, ציור של פטר גינז, \"כדור הארץ במבט מהירח\", דגל ישראל, תנ\"ך, דגלון סוכנות החלל הישראלית).", "options": [], "answer": "חיל האוויר / פטר גינז (טרזין) / אפולו-8 \"Earthrise\" / מדינת ישראל / העם היהודי-תנ\"ך / סוכנות החלל הישראלית.", "hint": "" }
      ]
    },

    "values": {
      "label": "ערכים",
      "questions": [
        { "id": "values-1", "points": 15, "type": "personal", "question": "שאלה אישית: מה הם ראשי התיבות גמ\"ח?", "options": [], "answer": "גמילות חסדים.", "hint": "" },
        { "id": "values-2", "points": 5, "type": "regular", "question": "איזו צדקה גדולה יותר: לסייע לאדם במציאת עבודה או לתת לו צדקה?", "options": [], "answer": "לעזור לו לעמוד על רגליו (מציאת עבודה) נחשב מעלה גדולה יותר.", "hint": "" },
        { "id": "values-3", "points": 5, "type": "regular", "question": "ממי לומדים את הערך של הכנסת אורחים ומאיזה אירוע?", "options": [], "answer": "מאברהם אבינו — הכנסת האורחים לשלושת המלאכים.", "hint": "" },
        { "id": "values-4", "points": 15, "type": "personal", "question": "שאלה אישית: משמיעים את השיר \"אליעזר בן יהודה\" (בית ראשון בלי פזמון). על מי נכתב השיר ומה הוא ניסה לקדם?", "options": [], "answer": "על אליעזר בן־יהודה; תחיית השפה העברית.", "hint": "" },
        { "id": "values-5", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: אני מתנה שעם ישראל קיבל במיוחד. מאז ועד היום תרבויות רבות למדו מעם ישראל. אולי ראשון, אולי שישי — אבל המקור זה אני… מי אני?", "options": [], "answer": "התורה (אפשר גם: עשרת הדיברות/ערכים מוסריים מהתורה).", "hint": "" },
        { "id": "values-6", "points": 20, "type": "duel", "question": "דו־קרב: גימטריה של הפסוק \"וַאֲהַבְתֶּם אֶת-הַגֵּר כִּי-גֵרִים הֱיִיתֶם בְּאֶרֶץ מִצְרָיִם\". מי מגיע ראשון לתשובה הנכונה?", "options": [], "answer": "", "hint": "אין גלגל הצלה" },
        { "id": "values-7", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: אני מופיע בעשרת הדיברות ביחס למשפחה, כבסיס לחברה מתוקנת, כמצווה שצריך לעשות ולא להימנע ממנה. מה אני?", "options": [], "answer": "כבד את אביך ואת אמך.", "hint": "" }
      ]
    },

    "symbols": {
      "label": "סמלים",
      "questions": [
        { "id": "symbols-1", "points": 5, "type": "regular", "question": "מאיזה אלמנט יהודי אחר הגיעו שני פסי התכלת בדגל ישראל?", "options": [], "answer": "מהטלית (טלית עם פסי תכלת).", "hint": "" },
        { "id": "symbols-2", "points": 10, "type": "for_everyone", "question": "שאלה לכולם: מי כתב את \"התקווה\"?", "options": [], "answer": "נפתלי הרץ אימבר.", "hint": "" },
        { "id": "symbols-3", "points": 15, "type": "personal", "question": "שאלה אישית: מה הסמל של המדינה ומאיפה הגיעו הסמלים שבו?", "options": [], "answer": "מנורה ושני ענפי זית; המנורה בהשראת מנורת בית המקדש (תבליטים עתיקים), ענפי הזית כסמל לשלום.", "hint": "" },
        { "id": "symbols-4", "points": 15, "type": "personal", "question": "שאלה אישית: מה הם ראשי התיבות תנ\"ך?", "options": [], "answer": "תורה, נביאים, כתובים.", "hint": "" },
        { "id": "symbols-5", "points": 5, "type": "regular", "question": "מה יש בתוך המזוזה?", "options": [], "answer": "קלף עם פרשיות \"שמע\" ו\"והיה אם שמוע\".", "hint": "" },
        { "id": "symbols-6", "points": 20, "type": "duel", "question": "דו־קרב: אומרים כמה שיותר שירי ירושלים תור־תור. מי שאחרי 5 שניות לא מוצא — מפסיד.", "options": [], "answer": "", "hint": "אין גלגל הצלה" },
        { "id": "symbols-7", "points": 10, "type": "for_everyone", "question": "שאלה לכולם (בכתיבה): באיזה תאריך עברי ולועזי נכתבה מגילת העצמאות? ואיפה?", "options": [], "answer": "ה׳ באייר תש\"ח (14 במאי 1948), בתל אביב — במוזיאון תל אביב (בית דיזנגוף/שד' רוטשילד 16).", "hint": "" }
      ]
    },

    "achievements": {
      "label": "הישגים",
      "questions": [
        { "id": "achievements-1", "points": 10, "type": "for_everyone", "question": "בעיה: חוסר מים בשטח מדברי — מה הפתרון הישראלי?", "options": [], "answer": "התפלת מים.", "hint": "" },
        { "id": "achievements-2", "points": 10, "type": "for_everyone", "question": "בעיה: סגידה לאלילי אבן וחומר — מה הרעיון/הפתרון שהביא עם ישראל?", "options": [], "answer": "אמונה בא־ל אחד.", "hint": "" },
        { "id": "achievements-3", "points": 10, "type": "for_everyone", "question": "בעיה: ניצול אנרגיה זמינה — מה הפתרון הישראלי הנפוץ?", "options": [], "answer": "דודי שמש.", "hint": "" },
        { "id": "achievements-4", "points": 10, "type": "for_everyone", "question": "בעיה: דאגה לעובד — מה העיקרון/הפתרון?", "options": [], "answer": "השבת (מנוחה שבועית).", "hint": "" },
        { "id": "achievements-5", "points": 10, "type": "for_everyone", "question": "בעיה: שימור מאגרי מידע ותוכנות — מה הפתרון (לפי המשחק)?", "options": [], "answer": "דיסק און קי.", "hint": "" },
        { "id": "achievements-6", "points": 10, "type": "for_everyone", "question": "בעיה: הגעה ליעד בדרך הקצרה — מה הפתרון הישראלי?", "options": [], "answer": "Waze (ווייז).", "hint": "" },
        { "id": "achievements-7", "points": 10, "type": "for_everyone", "question": "בעיה: ירי טילים — מה הפתרון ההגנתי הישראלי?", "options": [], "answer": "כיפת ברזל.", "hint": "" }
      ]
    }
  }
};

/* === State === */
const DEFAULT_STATE = {
  phase: "start",
  teamCount: 2,
  teams: [],
  currentTeamIndex: 0,
  used: {},
  duel: null // {catKey, qIndex, revealed}
};

let state = loadState() || clone(DEFAULT_STATE);

/* === Utils === */
function $(id) { return document.getElementById(id); }
function clone(obj) {
  if (typeof structuredClone === "function") return structuredClone(obj);
  return JSON.parse(JSON.stringify(obj));
}
function saveState() { localStorage.setItem("amIsraelGameState", JSON.stringify(state)); }
function loadState() {
  try { return JSON.parse(localStorage.getItem("amIsraelGameState")); }
  catch { return null; }
}
function resetState() {
  localStorage.removeItem("amIsraelGameState");
  state = clone(DEFAULT_STATE);
}
function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}
function showOnlyScreen(screenId) {
  ["screenStart", "screenBoard", "screenDuel", "screenEnd"].forEach(id => {
    const el = $(id);
    if (el) el.classList.add("hidden");
  });
  const target = $(screenId);
  if (target) target.classList.remove("hidden");
}

/* === Game rules helpers === */
function rowsCount() {
  return QUESTIONS?.meta?.board?.rows
    || Math.max(...Object.values(QUESTIONS.categories).map(c => c.questions.length));
}
function getQuestionBy(catKey, index0) {
  const cat = QUESTIONS.categories[catKey];
  if (!cat) return null;
  return cat.questions[index0] || null;
}
function getQuestionPoints(q) {
  return Number(q?.points || 0);
}

/* === Auto-score helper === */
function isAutoTrivia(q) {
  const hasOptions = Array.isArray(q?.options) && q.options.length > 0;
  const hasAnswer = String(q?.answer ?? "").trim() !== "";
  const flag = q?.autoScore === true;
  // Auto-score ONLY if explicitly flagged OR trivially a trivia (options+answer).
  return (flag && hasOptions && hasAnswer) || (hasOptions && hasAnswer);
}

/* === Start screen === */
function buildTeamsForm(teamCount) {
  const wrap = $("teamsForm");
  if (!wrap) return;
  wrap.innerHTML = "";
  for (let i = 0; i < teamCount; i++) {
    const row = document.createElement("div");
    row.className = "team-row";
    row.innerHTML = `
      <label class="team-label">קבוצה ${i + 1}</label>
      <input class="team-input" id="teamName${i}" type="text" placeholder="שם קבוצה ${i + 1}" />
    `;
    wrap.appendChild(row);
  }
}

function initTeamsFromForm() {
  const teamCount = Number($("teamCount")?.value || 2);
  state.teamCount = teamCount;
  state.teams = [];
  for (let i = 0; i < teamCount; i++) {
    const name = ($(`teamName${i}`)?.value || `קבוצה ${i + 1}`).trim() || `קבוצה ${i + 1}`;
    state.teams.push({ name, score: 0 });
  }
  state.currentTeamIndex = 0;
  state.used = {};
  state.duel = null;
  state.phase = "board";
  saveState();
}

/* === Board UI === */
function renderScoreBar() {
  const bar = $("scoreBar");
  if (!bar) return;
  bar.innerHTML = "";
  state.teams.forEach((t, i) => {
    const pill = document.createElement("div");
    pill.className = "score-pill" + (i === state.currentTeamIndex ? " active" : "");
    pill.textContent = `${t.name}: ${t.score}`;
    bar.appendChild(pill);
  });
}

function renderTurnLabel() {
  const el = $("turnLabel");
  if (!el) return;
  const t = state.teams[state.currentTeamIndex];
  el.textContent = t ? `תור: ${t.name}` : "";
}

function buildBoard() {
  const board = $("board");
  if (!board) return;

  board.innerHTML = "";

  const order = QUESTIONS.meta.categoriesOrder;
  const rCount = rowsCount();

  // Header row
  order.forEach(catKey => {
    const cell = document.createElement("div");
    cell.className = "board-cell board-header";
    cell.textContent = QUESTIONS.categories[catKey]?.label || catKey;
    board.appendChild(cell);
  });

  // Rows: question numbers (1..rCount)
  for (let r = 0; r < rCount; r++) {
    const displayNumber = r + 1;
    order.forEach(catKey => {
      const q = getQuestionBy(catKey, r);
      const btn = document.createElement("button");
      btn.className = "board-cell board-btn";
      btn.type = "button";
      btn.textContent = String(displayNumber);
      btn.dataset.cat = catKey;
      btn.dataset.qindex = String(r);
      btn.dataset.qid = q?.id || "";

      const isUsed = q?.id ? !!state.used[q.id] : true;
      btn.disabled = !q || isUsed;
      if (btn.disabled) btn.classList.add("used");

      btn.addEventListener("click", () => {
        if (!q) return;

        // NEW: duel goes to duel screen (2-stage)
        if (q.type === "duel") {
          openDuel(catKey, r);
          return;
        }

        openQuestionModal(catKey, r);
      });

      board.appendChild(btn);
    });
  }
}

function advanceTurn() {
  if (!state.teams.length) return;
  state.currentTeamIndex = (state.currentTeamIndex + 1) % state.teams.length;
  saveState();
  renderScoreBar();
  renderTurnLabel();
}

function rerenderBoardUI() {
  renderScoreBar();
  renderTurnLabel();
  buildBoard();
}

/* === Duel logic (NEW) === */
function openDuel(catKey, qIndex) {
  state.phase = "duel";
  state.duel = { catKey, qIndex, revealed: false };
  saveState();
  renderDuelFromState();
  showOnlyScreen("screenDuel");
}

function closeDuel(goNextTurnIfRevealed) {
  // If the question was actually revealed, we consider it "used"
  if (goNextTurnIfRevealed) {
    markUsed(state.duel?.catKey, state.duel?.qIndex);
    state.phase = "board";
    state.duel = null;
    saveState();
    advanceTurn();
    rerenderBoardUI();
    showOnlyScreen("screenBoard");
    return;
  }

  // Just cancel (didn't reveal) — do not burn question
  state.phase = "board";
  state.duel = null;
  saveState();
  showOnlyScreen("screenBoard");
}

function renderDuelFromState() {
  const d = state.duel;
  if (!d) return;

  const q = getQuestionBy(d.catKey, d.qIndex);
  if (!q) return;

  const points = getQuestionPoints(q);
  const displayNumber = d.qIndex + 1;
  const catLabel = QUESTIONS.categories[d.catKey]?.label || d.catKey;

  // Meta + intro (screen 1)
  setText("duelMeta", `${catLabel} • שאלה ${displayNumber} • ${points} נקודות`);
  setText("duelIntro", "דו־קרב! קודם כל כולם מוכנים. רק אחרי זה לוחצים 'הצג שאלה'.");

  // Buttons & question area
  const area = $("duelQuestionArea");
  const qText = $("duelQuestionText");
  const showBtn = $("btnDuelShowQuestion");

  if (area) area.classList.toggle("hidden", !d.revealed);

  if (showBtn) {
    showBtn.disabled = !!d.revealed;
  }

  if (d.revealed) {
    if (qText) qText.textContent = q.question || "";

    // Winner buttons
    const b0 = $("btnDuelWinnerTeam0");
    const b1 = $("btnDuelWinnerTeam1");
    const b2 = $("btnDuelWinnerTeam2");

    if (b0) {
      b0.textContent = `ניצחון: ${state.teams[0]?.name ?? "קבוצה 1"}`;
      b0.classList.remove("hidden");
    }
    if (b1) {
      b1.textContent = `ניצחון: ${state.teams[1]?.name ?? "קבוצה 2"}`;
      b1.classList.remove("hidden");
    }
    if (b2) {
      if (state.teams.length >= 3) {
        b2.textContent = `ניצחון: ${state.teams[2]?.name ?? "קבוצה 3"}`;
        b2.classList.remove("hidden");
      } else {
        b2.classList.add("hidden");
      }
    }
  }
}

function awardDuelWinner(teamIndex) {
  const d = state.duel;
  if (!d) return;

  const q = getQuestionBy(d.catKey, d.qIndex);
  if (!q) return;

  const points = getQuestionPoints(q);

  if (state.teams[teamIndex]) {
    state.teams[teamIndex].score += Number(points || 0);
  }

  // burn question
  markUsed(d.catKey, d.qIndex);

  // back to board
  state.phase = "board";
  state.duel = null;
  saveState();

  advanceTurn();
  rerenderBoardUI();
  showOnlyScreen("screenBoard");
}

/* === Modal logic === */
let activeCatKey = null;
let activeQIndex = null;
let timerInterval = null;
let timerRemaining = 0;

function openQuestionModal(catKey, qIndex) {
  activeCatKey = catKey;
  activeQIndex = qIndex;

  const q = getQuestionBy(catKey, qIndex);
  if (!q) return;

  const points = getQuestionPoints(q);
  const displayNumber = qIndex + 1;

  setText("modalCategory", QUESTIONS.categories[catKey]?.label || catKey);
  setText("modalMeta", `שאלה ${displayNumber} • ${points} נקודות`);
  setText("modalQuestion", q.question || "");

  // --- OPTIONS (FIXED: show/hide correctly) ---
  const optWrap = $("modalOptions");
  if (optWrap) {
    optWrap.innerHTML = "";

    const hasOptions = Array.isArray(q.options) && q.options.length > 0;

    if (hasOptions) {
      // IMPORTANT: show options container (it was hidden in HTML)
      optWrap.classList.remove("hidden");

      q.options.forEach(opt => {
        const b = document.createElement("button");
        b.className = "option-btn";
        b.type = "button";
        b.textContent = opt;

        b.addEventListener("click", () => {
          // Visual select
          optWrap.querySelectorAll(".option-btn").forEach(x => x.classList.remove("selected"));
          b.classList.add("selected");

          // Auto-score for trivia
          if (isAutoTrivia(q)) {
            // prevent double clicks
            optWrap.querySelectorAll(".option-btn").forEach(x => (x.disabled = true));

            const chosen = String(opt).trim();
            const correct = String(q.answer).trim();

            if (chosen === correct) {
              // correct -> add points immediately to current team
              awardPoints(state.currentTeamIndex, points);
            } else {
              // wrong -> no points, burn question and advance turn
              markUsed(activeCatKey, activeQIndex);
              closeQuestionModal();
              advanceTurn();
              rerenderBoardUI();
            }
          }
        });

        optWrap.appendChild(b);
      });

    } else {
      // hide options when none
      optWrap.classList.add("hidden");
    }
  }

  setText("modalAnswer", "");
  $("btnShowAnswer")?.classList.remove("hidden");

  // --- Award buttons ---
  // If this is auto-trivia, we hide manual award buttons (but keep "לא לתת נקודות" working)
  if (!isAutoTrivia(q)) {
    renderTeamAwardButtons(points);
  } else {
    const wrap = $("teamButtons");
    if (wrap) wrap.innerHTML = "";

    const none = $("btnNoPoints");
    if (none) {
      none.onclick = () => {
        markUsed(activeCatKey, activeQIndex);
        closeQuestionModal();
        advanceTurn();
        rerenderBoardUI();
      };
    }
  }

  stopTimer();
  updateTimerUI(0, 0);

  $("modalOverlay")?.classList.remove("hidden");
}

function closeQuestionModal() {
  $("modalOverlay")?.classList.add("hidden");
  stopTimer();
  activeCatKey = null;
  activeQIndex = null;
}

function markUsed(catKey, qIndex) {
  const q = getQuestionBy(catKey, qIndex);
  if (!q?.id) return;
  state.used[q.id] = true;
  saveState();
}

function renderTeamAwardButtons(points) {
  const wrap = $("teamButtons");
  if (!wrap) return;
  wrap.innerHTML = "";

  state.teams.forEach((t, idx) => {
    const b = document.createElement("button");
    b.className = "team-award-btn";
    b.type = "button";
    b.textContent = `לתת נקודות ל־${t.name}`;
    b.addEventListener("click", () => awardPoints(idx, points));
    wrap.appendChild(b);
  });

  const none = $("btnNoPoints");
  if (none) {
    none.onclick = () => {
      markUsed(activeCatKey, activeQIndex);
      closeQuestionModal();
      advanceTurn();
      rerenderBoardUI();
    };
  }
}

function awardPoints(teamIndex, points) {
  if (teamIndex == null) return;
  const pts = Number(points || 0);

  if (state.teams[teamIndex]) {
    state.teams[teamIndex].score += pts;
  }

  markUsed(activeCatKey, activeQIndex);
  saveState();

  closeQuestionModal();
  advanceTurn();
  rerenderBoardUI();
}

/* === Timer / Helps === */
function startTimer(seconds) {
  stopTimer();
  const total = Number(seconds || 0);
  if (total <= 0) {
    updateTimerUI(0, 0);
    return;
  }

  timerRemaining = total;
  updateTimerUI(timerRemaining, total);

  timerInterval = setInterval(() => {
    timerRemaining -= 1;
    if (timerRemaining <= 0) {
      stopTimer();
      updateTimerUI(0, total);
      return;
    }
    updateTimerUI(timerRemaining, total);
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

function updateTimerUI(remaining, total) {
  const bar = $("timerBar");
  const fill = $("timerFill");
  const text = $("timerText");
  if (!bar || !fill || !text) return;

  if (!total || total <= 0) {
    bar.classList.add("hidden");
    fill.style.width = "0%";
    text.textContent = "";
    return;
  }

  bar.classList.remove("hidden");
  const pct = Math.max(0, Math.min(1, remaining / total));
  fill.style.width = `${pct * 100}%`;
  text.textContent = `${remaining}s`;
}

/* === Wiring === */
function wireTopButtons() {
  const resetBtn = $("btnReset");
  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      resetState();
      applyStateToUI();
    });
  }

  const resumeBtn = $("btnResume");
  if (resumeBtn) {
    resumeBtn.addEventListener("click", () => {
      const loaded = loadState();
      if (!loaded) return;
      state = loaded;
      applyStateToUI();
    });
  }
}

function wireStartScreen() {
  const teamCountSel = $("teamCount");
  if (teamCountSel) {
    teamCountSel.addEventListener("change", () => buildTeamsForm(Number(teamCountSel.value)));
  }

  const startBtn = $("btnStart");
  if (startBtn) {
    startBtn.addEventListener("click", () => {
      initTeamsFromForm();
      applyStateToUI();
    });
  }
}

function wireModalButtons() {
  $("btnCloseModal")?.addEventListener("click", closeQuestionModal);

  $("btnHelpTeacher")?.addEventListener("click", () => {
    startTimer(0);
    alert("עזרת מורה הופעלה (המנחה מחליט איך לעזור).");
  });

  $("btnHelpGoogle")?.addEventListener("click", () => {
    startTimer(20);
  });

  $("btnShowAnswer")?.addEventListener("click", () => {
    const q = getQuestionBy(activeCatKey, activeQIndex);
    if (!q) return;
    setText("modalAnswer", `תשובה: ${q.answer ?? ""}`);
  });

  $("modalOverlay")?.addEventListener("click", (e) => {
    if (e.target && e.target.id === "modalOverlay") closeQuestionModal();
  });
}

function wireDuelButtons() {
  $("btnDuelShowQuestion")?.addEventListener("click", () => {
    if (!state.duel) return;
    state.duel.revealed = true;
    saveState();
    renderDuelFromState();
  });

  $("btnDuelBack")?.addEventListener("click", () => {
    // אם כבר חשפנו את השאלה → זה "שומש" ונעבור תור (בלי נקודות)
    const revealed = !!state.duel?.revealed;
    closeDuel(revealed);
  });

  $("btnDuelWinnerTeam0")?.addEventListener("click", () => awardDuelWinner(0));
  $("btnDuelWinnerTeam1")?.addEventListener("click", () => awardDuelWinner(1));
  $("btnDuelWinnerTeam2")?.addEventListener("click", () => awardDuelWinner(2));
}

function applyStateToUI() {
  if (!state.teams || !state.teams.length) {
    state.phase = "start";
    saveState();
    showOnlyScreen("screenStart");
    buildTeamsForm(Number($("teamCount")?.value || 2));
    return;
  }

  // NEW: resume duel screen if we were in duel
  if (state.phase === "duel" && state.duel) {
    showOnlyScreen("screenDuel");
    renderDuelFromState();
    return;
  }

  showOnlyScreen("screenBoard");
  renderScoreBar();
  renderTurnLabel();
  buildBoard();
}

function boot() {
  wireTopButtons();
  wireStartScreen();
  wireModalButtons();
  wireDuelButtons();

  buildTeamsForm(Number($("teamCount")?.value || 2));

  const loaded = loadState();
  if (loaded) state = loaded;

  applyStateToUI();
}

document.addEventListener("DOMContentLoaded", boot);

